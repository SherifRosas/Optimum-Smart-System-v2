from django.contrib.auth import get_user_model
from django.contrib.auth.password_validation import validate_password
from rest_framework import serializers
from orders.utils import sanitize_text, sanitize_email, sanitize_phone
from .models import UserProfile, PasswordResetRequest

User = get_user_model()

class UserRegistrationSerializer(serializers.ModelSerializer):
    """Serializer for user registration"""
    password = serializers.CharField(write_only=True, required=True, validators=[validate_password])
    password2 = serializers.CharField(write_only=True, required=True, label='Confirm Password')
    email = serializers.EmailField(required=True)
    phone_number = serializers.CharField(max_length=20, required=False, allow_blank=True)
    company_name = serializers.CharField(max_length=200, required=False, allow_blank=True)
    role = serializers.ChoiceField(
        required=False,
        choices=UserProfile.RoleChoices.choices,
        default=UserProfile.RoleChoices.PRODUCT_REQUESTER
    )

    class Meta:
        model = User
        fields = ('username', 'email', 'password', 'password2', 'first_name', 'last_name', 
                  'phone_number', 'company_name', 'role')
        extra_kwargs = {
            'first_name': {'required': False},
            'last_name': {'required': False},
        }

    def validate_username(self, value):
        """Sanitize username"""
        if not value or len(value.strip()) == 0:
            raise serializers.ValidationError("Username cannot be empty")
        # Username should be alphanumeric with underscores/hyphens
        import re
        if not re.match(r'^[a-zA-Z0-9_-]+$', value):
            raise serializers.ValidationError("Username can only contain letters, numbers, underscores, and hyphens")
        return sanitize_text(value.strip())

    def validate_email(self, value):
        """Sanitize and validate email"""
        sanitized = sanitize_email(value)
        if not sanitized:
            raise serializers.ValidationError("Invalid email format")
        return sanitized

    def validate_phone_number(self, value):
        """Sanitize phone number"""
        if value:
            return sanitize_phone(value)
        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate(self, attrs):
        if attrs['password'] != attrs['password2']:
            raise serializers.ValidationError({"password": "Password fields didn't match."})
        return attrs

    def create(self, validated_data):
        # Remove password2 and profile fields
        validated_data.pop('password2')
        phone_number = validated_data.pop('phone_number', None)
        company_name = validated_data.pop('company_name', None)
        role = validated_data.pop('role', UserProfile.RoleChoices.PRODUCT_REQUESTER)
        
        # Create user
        password = validated_data.pop('password')
        user = User.objects.create_user(**validated_data)
        user.set_password(password)
        user.save()
        
        # Create profile
        UserProfile.objects.create(
            user=user,
            phone_number=phone_number,
            company_name=company_name,
            role=role
        )
        
        return user


class UserProfileSerializer(serializers.ModelSerializer):
    """Serializer for user profile"""
    username = serializers.CharField(source='user.username', read_only=True)
    email = serializers.EmailField(source='user.email', read_only=True)
    first_name = serializers.CharField(source='user.first_name', required=False)
    last_name = serializers.CharField(source='user.last_name', required=False)
    role_display = serializers.CharField(source='get_role_display', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = UserProfile
        fields = (
            'id',
            'username',
            'email',
            'first_name',
            'last_name',
            'phone_number',
            'company_name',
            'role',
            'role_display',
            'status',
            'status_display',
            'metadata',
            'created_at',
            'updated_at',
        )
        read_only_fields = ('id', 'created_at', 'updated_at')

    def validate_phone_number(self, value):
        """Sanitize phone number"""
        if value:
            return sanitize_phone(value)
        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        # Update user fields if provided
        user_data = validated_data.pop('user', {})
        if user_data:
            user = instance.user
            if 'first_name' in user_data:
                user.first_name = sanitize_text(user_data['first_name'].strip()) if user_data['first_name'] else ''
            if 'last_name' in user_data:
                user.last_name = sanitize_text(user_data['last_name'].strip()) if user_data['last_name'] else ''
            user.save()
        
        # Update profile fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        return instance


class UserSerializer(serializers.ModelSerializer):
    """Basic user serializer"""
    profile = UserProfileSerializer(read_only=True)

    class Meta:
        model = User
        fields = ('id', 'username', 'email', 'first_name', 'last_name', 'profile')
        read_only_fields = ('id',)


class AdminUserSerializer(serializers.ModelSerializer):
    """Serializer to allow admin management of users and profiles"""

    role = serializers.ChoiceField(
        choices=UserProfile.RoleChoices.choices,
        source='profile.role'
    )
    status = serializers.ChoiceField(
        choices=UserProfile.StatusChoices.choices,
        source='profile.status'
    )
    phone_number = serializers.CharField(
        source='profile.phone_number',
        allow_blank=True,
        required=False
    )
    company_name = serializers.CharField(
        source='profile.company_name',
        allow_blank=True,
        required=False
    )

    class Meta:
        model = User
        fields = [
            'id',
            'username',
            'email',
            'first_name',
            'last_name',
            'role',
            'status',
            'phone_number',
            'company_name',
        ]

    def validate_email(self, value):
        """Sanitize and validate email"""
        sanitized = sanitize_email(value)
        if not sanitized:
            raise serializers.ValidationError("Invalid email format")
        return sanitized

    def validate_phone_number(self, value):
        """Sanitize phone number"""
        if value:
            return sanitize_phone(value)
        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs


        return value

    def validate_company_name(self, value):
        """Sanitize company name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_first_name(self, value):
        """Sanitize first name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def validate_last_name(self, value):
        """Sanitize last name"""
        if value:
            return sanitize_text(value.strip())
        return value

    def update(self, instance, validated_data):
        profile_data = validated_data.pop('profile', {})
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()

        profile = getattr(instance, 'profile', None)
        if profile and profile_data:
            for attr, value in profile_data.items():
                setattr(profile, attr, value)
            profile.save()
        return instance


class PasswordResetRequestSerializer(serializers.ModelSerializer):
    """Serializer for password reset requests"""
    target_email = serializers.EmailField(source='target_user.email', read_only=True)
    requested_by_email = serializers.EmailField(source='requested_by.email', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = PasswordResetRequest
        fields = [
            'id',
            'target_user',
            'target_email',
            'requested_by',
            'requested_by_email',
            'status',
            'status_display',
            'reason',
            'expires_at',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'status',
            'requested_by',
            'requested_by_email',
            'target_email',
            'approved_at',
            'decided_by',
            'created_at',
            'updated_at',
        ]


class PasswordResetActionSerializer(serializers.Serializer):
    """Serializer for admin password reset approvals"""
    approve = serializers.BooleanField()
    new_password = serializers.CharField(required=False, allow_blank=True)

    def validate(self, attrs):
        approve = attrs.get('approve')
        new_password = attrs.get('new_password')
        if approve and not new_password:
            raise serializers.ValidationError("New password is required when approving a reset.")
        if new_password:
            validate_password(new_password)
        return attrs

